<?php

namespace App\Admin\Controllers;

use Encore\Admin\Controllers\AuthController as BaseAuthController;
use Encore\Admin\Facades\Admin;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Redirect;
use Illuminate\Support\Facades\Validator;

class AuthController extends BaseAuthController
{
    /**
     * Login page
     */
    public function login()
    {
        // return parent::getLogin(); // TODO: Change the autogenerated stub
        if (!Auth::guard('admin')->guest()) {
            return redirect(config('admin.route.prefix'));
        }

        return view('admin::home.login');
    }

    /**
     *
     * @param Request $request
     *
     * @return mixed
     */
    public function loginCheck(Request $request)
    {
        $credentials = $request->only(['username', 'password']);

        $validator = Validator::make($request->only(['username', 'password','captcha']), [
            'username' => 'required',
            'password' => 'required',
            'captcha'  => 'required|captcha',
        ], [
            'username.required' => '请填写用户名',
            'password.required' => '请填写密码',
            'captcha.required'  => '请填写验证码',
            'captcha.captcha'   => '验证码错误',
        ]);

        if ($validator->fails()) {
            return Redirect::back()->withInput()->withErrors($validator);
        }

        if (Auth::guard('admin')->attempt($credentials)) {
            admin_toastr(trans('admin.login_successful'));

            session('firstLogin', Admin::user()['id']); // 首次登录用户配置

            return redirect()->intended(config('admin.route.prefix'));
        }

        return Redirect::back()->withInput()->withErrors([
            'username' => $this->getFailedLoginMessage()
        ]);
    }
}
